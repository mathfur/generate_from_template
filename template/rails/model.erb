<% require "nkf" %>

<%- models = OOHelper::Models.new(csv_fname) -%>

<!-- Migration files -->
<% migration_file_suffix ||=0 %>
<%- OOHelper::Models.new(csv_fname).models do |m| -%>
<% migration_file_suffix+=1 %>
--[db/migrate/<%= (Time.now + migration_file_suffix).strftime('%Y%m%d%H%M%S') %>_create_<%= m.table_name %>.rb:c]-------------------------------------------
class Create<%= m.multiple.camelize %> < ActiveRecord::Migration
  def change
    create_table :<%= m.table_name %> do |t|
      <%- m.attrs do |a| -%>
      t.column :<%= a.name %>, :<%= a.type %><%= a.allow_null "TRUE", ", :null => false" %><%= a.default "null",", :default => $v" %>
      <%- end -%>

      t.timestamp
    end

    <%- m.attrs do |a| -%>
    <%= a.index "", "add_index :#{m.table_name}, :#{a.name}" %>
    <%- end -%>
  end
end
--
<%- end -%>

<!-- Model -->
<%- models.each do |m| -%>
--[app/models/<%= m.singularize %>.rb:c]-------------------------------------------
# -*- encoding: utf-8 -*-
class <%= m.sc %> < ActiveRecord::Base
  <%- m.has_one_models(models).each do |m2| -%>
  has_one :<%= m2.su %>
  <%- end -%>
  <%- m.has_many_models(models).each do |m2| -%>
  has_many :<%= m2.mu %>
  <%- end -%>
  <%- m.belongs_to_models(models).each do |m2| -%>
  belongs_to :<%= m2.su %>
  <%- end -%>
end
--

<%- end -%>

--[config/locales/model_ja.yml:c]----------------------------
ja:
  activerecord:
    models:
      <%- OOHelper::Models.new(csv_fname).models do |m| -%>
      <%= m.instance %>: <%= NKF.nkf("-w",m.ja_name || "") %>
      <%- end -%>
    attributes:
      <%- OOHelper::Models.new(csv_fname).models do |m| -%>
      <%= m.instance %>:
        <%- m.attrs do |a| -%>
        <%= a.name %>: <%= a.ja_name %>
        <%- end -%>
      <%- end -%>
--

<%- models.each do |m| -%>
--[app/views/<%= m.mu %>/index.html.haml:c]-------------------------

--

--[app/views/<%= m.mu %>/show.html.haml:c]-------------------------

--

--[app/views/<%= m.mu %>/new.html.haml:c]-------------------------
%h1 Editing <%= m.su %>
= render 'form'

= link_to t('label.show'), @<%= m.su %>
= link_to t('label.back'), <%= m.mu %>_path
--

--[app/views/<%= m.mu %>/edit.html.haml:c]-------------------------
%h1 Editing <%= m.su %>
= render 'form'

= link_to t('label.show'), @<%= m.su %>
= link_to t('label.back'), <%= m.mu %>_path
--

<%- end -%>


<%- models = OOHelper::Models.new(csv_fname) -%>
<%- models.each do |m| -%>
--[app/controllers/<%= m.mu %>_controller.rb:c]----------------------
class <%= m.mc %>Controller < ApplicationController
  def index
    @<%= m.mu %> = <%= m.sc %>.all

    respond_to do |format|
      format.html
      format.json { render json: @<%= m.su %> }
    end
  end

  def show
    @<%= m.su %> = <%= m.sc %>.find(params[:id])
    <%-# has_many -%>
    <%- m.has_many_models(models).each do |m_| -%>
    @<%= m_.mu %> = @<%= m.su %>.<%= m_.mu %>
    <%- end -%>
    <%- m.has_one_models(models).each do |m_| -%>
    @<%= m_.su %> = @<%= m.su %>.<%= m_.su %> || <%= m_.sc %>.new(:<%= m.su %>_id => @<%= m.su %>.id)
    <%- end -%>
    <%-# has_many -%>
    <%- m.has_many_models(models).each do |m_| -%>
    @<%= m_.mu %> = @<%= m.su %>.<%= m_.mu %>
    <%- end -%>

    respond_to do |format|
      format.html
      format.json { render json: @<%= m.su %> }
    end
  end

  def new
    @<%= m.su %> = <%= m.sc %>.new

    respond_to do |format|
      format.html
      format.json { render json: @<%= m.su %> }
    end
  end

  def edit
    @<%= m.su %> = <%= m.sc %>.find(params[:id])
    <%-# has_one -%>
    <%- m.has_one_models(models).each do |m_| -%>
    @<%= m_.su %> = @<%= m.su %>.<%= m_.su %> || <%= m_.sc %>.new(:<%= m.su %>_id => @<%= m.su %>.id)
    <%- end -%>
    <%-# has_many -%>
    <%- m.has_many_models(models).each do |m_| -%>
    @<%= m_.mu %> = @<%= m.su %>.<%= m_.mu %>
    <%- end -%>
  end

  def create
    @<%= m.su %> = <%= m.sc %>.new(params[:<%= m.su %>])

    respond_to do |format|
      if @<%= m.su %>.save
        format.html { redirect_to @<%= m.su %>, notice: '<%= m.sc %> was successfully created.' }
        format.json { render json: @<%= m.su %>, status: :created, location: @<%= m.su %> }
      else
        format.html { render action: "new" }
        format.json { render json: @<%= m.su %>.errors, status: :unprocessable_entity }
      end
    end
  end

  def update
    @<%= m.su %> = <%= m.sc %>.find(params[:id])
    <%-# has_one -%>
    <%- m.has_one_models(models).each do |m_| -%>
    @<%= m_.su %> = <%= m_.sc %>.find(params[:<%= m_.su %>][:id])
    <%- end -%>

    respond_to do |format|
      begin
        ActiveRecord::Base.transaction do
          # TODO: 冗長なので後で直す
          raise unless @<%= m.su %>.valid?
          <%- m.has_one_models(models).each do |m_| -%>
          raise unless @<%= m_.su %>.valid?
          <%- end -%>
          @<%= m.su %>.update_attributes(params[:<%= m.su %>])
          <%- m.has_one_models(models).each do |m_| -%>
          @<%= m_.su %>.update_attributes(params[:<%= m_.su %>])
          <%- end -%>
          format.html { redirect_to @<%= m.su %>, notice: '<%= m.sc %> was successfully updated.' }
          format.json { head :ok }
        end
      rescue
        format.html { render action: "edit" }
        format.json { render json: @<%= m.su %>.errors, status: :unprocessable_entity }
      end
    end
  end

  def destroy
    @<%= m.su %> = <%= m.sc %>.find(params[:id])
    @<%= m.su %>.destroy

    respond_to do |format|
      format.html { redirect_to <%= m.mu %> }
      format.json { head :ok }
    end
  end
end
--

<%- end -%>

--[template/view.csv:c]-------------------------------------
,,,etc,etc,etc,etc,etc,css,css,
,,,cattr_val,header,cell_val,klass,tooltip,text-align,width,
<%- OOHelper::Models.new(csv_fname).models do |m| -%>
<%- # index.html -%>
<%= m.single %>-index,cattrs,locations,<%= m.mu %>#index#main
<%= m.single %>-index,cattrs,template,index
<%= m.single %>-index,cattrs,locals,<%= m.multiple %>
<%= m.single %>-index,cattrs,before_each,@<%= m.multiple %>
<%= m.single %>-index,cattrs,ja_name,<%= m.single %>_ja_name_TODO
<%= m.single %>-index,cattrs,in_global_menu,TRUE
<%= m.single %>-index,cattrs,header,xxxHEADER(<%= m.single %>_index)
<%- m.attrs do |a| -%>
<%= m.single %>-index,attrs,<%= a.name %>,,{default},"link_to <%= m.single %>.<%= a.name %>, <%= m.single %>_path(<%= m.single %>.id)"
<%- end -%>
<%- # new.html, edit.html用 -%>
<%= m.single %>-edit,cattrs,locations,"<%= m.mu %>#_form#main"
<%= m.single %>-edit,cattrs,template,show
<%= m.single %>-edit,cattrs,locals,"<%= m.single %>,f"
<%= m.single %>-edit,cattrs,ja_name,<%= m.single %>_ja_name_TODO
<%= m.single %>-edit,cattrs,in_global_menu,<%= m.single %>
<%= m.single %>-edit,cattrs,header,xxxHEADER(<%= m.single %>_new)
<%= m.single %>-edit,cattrs,submit,normal
<%- m.attrs do |a| -%>
<%= m.single %>-edit,attrs,<%= a.name %>,,{default},"text_field :<%= m.su %>, :<%= a.name %>"
<%- end -%>
<%- # ---  new.html, edit.html内has_oneテーブル用 -%>
<%- m.has_one_models(models).each do |m_| -%>
<%= m.single %>-<%= m_.single %>-edit,cattrs,locations,"<%= m.mu %>#_form#main"
<%= m.single %>-<%= m_.single %>-edit,cattrs,template,show
<%= m.single %>-<%= m_.single %>-edit,cattrs,locals,"<%= m_.single %>"
<%= m.single %>-<%= m_.single %>-edit,cattrs,ja_name,<%= m_.single %>_ja_name_TODO
<%= m.single %>-<%= m_.single %>-edit,cattrs,in_global_menu,<%= m_.single %>
<%= m.single %>-<%= m_.single %>-edit,cattrs,header,xxxHEADER(<%= m_.single %>_new)
<%= m.single %>-<%= m_.single %>-edit,cattrs,before_table,"= hidden_field :<%= m_.su %>, :id"
<%- m_.attrs do |a| -%>
<%= m.single %>-<%= m_.single %>-edit,attrs,<%= a.name %>,,{default},"text_field :<%= m_.su %>, :<%= a.name %>"
<%- end -%>
<%- end -%>
<%- # show.html -%>
<%= m.single %>-show,cattrs,locations,<%= m.mu %>#show#main
<%= m.single %>-show,cattrs,template,show
<%= m.single %>-show,cattrs,locals,<%= m.single %>
<%= m.single %>-show,cattrs,ja_name,<%= m.single %>_ja_name_TODO
<%= m.single %>-show,cattrs,in_global_menu,<%= m.single %>
<%= m.single %>-show,cattrs,header,xxxHEADER(<%= m.single %>_new
<%- m.attrs do |a| -%>
<%= m.single %>-show,attrs,<%= a.name %>,,{default},@<%= m.single %>.<%= a.name %>
<%- end -%>
<%- # ---  show.html内has_oneテーブル用 -%>
<%- m.has_one_models(models).each do |m_| -%>
<%= m.single %>-<%= m_.single %>-show,cattrs,locations,"<%= m.mu %>#show#main"
<%= m.single %>-<%= m_.single %>-show,cattrs,template,show
<%= m.single %>-<%= m_.single %>-show,cattrs,locals,"<%= m_.single %>"
<%= m.single %>-<%= m_.single %>-show,cattrs,ja_name,<%= m_.single %>_ja_name_TODO
<%= m.single %>-<%= m_.single %>-show,cattrs,in_global_menu,<%= m_.single %>
<%= m.single %>-<%= m_.single %>-show,cattrs,header,xxxHEADER(<%= m_.single %>_new)
<%- m_.attrs do |a| -%>
<%= m.single %>-<%= m_.single %>-show,attrs,<%= a.name %>,,{default},@<%= m_.su %>.<%= a.name %>
<%- end -%>
<%- end -%>
<%- # ---  show.html内has_manyテーブル用 -%>
<%- m.has_many_models(models).each do |m_| -%>
<%= m.single %>-<%= m_.mu %>-show,cattrs,locations,"<%= m.mu %>#show#main"
<%= m.single %>-<%= m_.mu %>-show,cattrs,template,index
<%= m.single %>-<%= m_.mu %>-show,cattrs,locals,"<%= m_.mu %>"
<%= m.single %>-<%= m_.mu %>-show,cattrs,before_each,"@<%= m_.mu %>"
<%= m.single %>-<%= m_.mu %>-show,cattrs,ja_name,<%= m_.single %>_ja_name_TODO
<%= m.single %>-<%= m_.mu %>-show,cattrs,in_global_menu,<%= m_.single %>
<%= m.single %>-<%= m_.mu %>-show,cattrs,header,xxxHEADER(<%= m_.single %>_new)
<%- m_.attrs do |a| -%>
<%= m.single %>-<%= m_.mu %>-show,attrs,<%= a.name %>,,{default},"link_to <%= m_.su %>.<%= a.name %>, <%= m_.su %>_path(<%= m_.su %>.id)"
<%- end -%>
<%- end -%>
<%- end -%>
--

