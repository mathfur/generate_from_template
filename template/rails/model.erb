<% require "nkf" %>

<%- models = OOHelper::Models.new(csv_fname) -%>

<!-- Migration files -->
<% migration_file_suffix ||=0 %>
<%- OOHelper::Models.new(csv_fname).models do |m| -%>
<% migration_file_suffix+=1 %>
--[db/migrate/<%= (Time.now + migration_file_suffix).strftime('%Y%m%d%H%M%S') %>_create_<%= m.table_name %>.rb:c]-------------------------------------------
class Create<%= m.multiple.camelize %> < ActiveRecord::Migration
  def change
    create_table :<%= m.table_name %> do |t|
      <%- m.attrs do |a| -%>
      t.column :<%= a.name %>, :<%= a.type %><%= a.allow_null "TRUE", ", :null => false" %><%= a.default "null",", :default => $v" %>
      <%- end -%>

      t.timestamp
    end

    <%- m.attrs do |a| -%>
    <%= a.index "", "add_index :#{m.table_name}, :#{a.name}" %>
    <%- end -%>
  end
end
--
<%- end -%>

<!-- Model -->
<%- models.each do |m| -%>
--[app/models/<%= m.singularize %>.rb:c]-------------------------------------------
# -*- encoding: utf-8 -*-
class <%= m.sc %> < ActiveRecord::Base
  <%- m.has_one_models(models).each do |m2| -%>
  has_one :<%= m2.su %>
  <%- end -%>
  <%- m.has_many_models(models).each do |m2| -%>
  has_many :<%= m2.mu %>
  <%- end -%>
  <%- m.belongs_to_models(models).each do |m2| -%>
  belongs_to :<%= m2.su %>
  <%- end -%>
end
--

<%- end -%>

--[config/locales/model_ja.yml:c]----------------------------
ja:
  activerecord:
    models:
      <%- OOHelper::Models.new(csv_fname).models do |m| -%>
      <%= m.instance %>: <%= NKF.nkf("-w",m.ja_name || "") %>
      <%- end -%>
    attributes:
      <%- OOHelper::Models.new(csv_fname).models do |m| -%>
      <%= m.instance %>:
        <%- m.attrs do |a| -%>
        <%= a.name %>: <%= a.ja_name %>
        <%- end -%>
      <%- end -%>
--

<%- models = OOHelper::Models.new(csv_fname) -%>
<%- models.each do |m| -%>
--[app/controllers/<%= m.mu %>_controller.rb:c]----------------------
class <%= m.mc %>Controller < ApplicationController
  def index
    @<%= m.mu %> = <%= m.sc %>.all

    respond_to do |format|
      format.html
      format.json { render json: @<%= m.su %> }
    end
  end

  def show
    @<%= m.su %> = <%= m.sc %>.find(params[:id])

    respond_to do |format|
      format.html
      format.json { render json: @<%= m.su %> }
    end
  end

  def new
    @<%= m.su %> = <%= m.sc %>.new

    respond_to do |format|
      format.html
      format.json { render json: @<%= m.su %> }
    end
  end

  def edit
    @<%= m.su %> = <%= m.sc %>.find(params[:id])
    <%- m.has_one_models(models).each do |m_| -%>
    @<%= m_.su %> = @<%= m.su %>.<%= m_.su %> || <%= m_.sc %>.new(:<%= m.su %>_id => @<%= m.su %>.id)
    <%- end -%>
  end

  def create
    @<%= m.su %> = <%= m.sc %>.new(params[:<%= m.su %>])

    respond_to do |format|
      if @<%= m.su %>.save
        format.html { redirect_to @<%= m.su %>, notice: '<%= m.sc %> was successfully created.' }
        format.json { render json: @<%= m.su %>, status: :created, location: @<%= m.su %> }
      else
        format.html { render action: "new" }
        format.json { render json: @<%= m.su %>.errors, status: :unprocessable_entity }
      end
    end
  end

  def update
    @<%= m.su %> = <%= m.sc %>.find(params[:id])

    respond_to do |format|
      if @<%= m.su %>.update_attributes(params[:<%= m.su %>])
        format.html { redirect_to @<%= m.su %>, notice: '<%= m.sc %> was successfully updated.' }
        format.json { head :ok }
      else
        format.html { render action: "edit" }
        format.json { render json: @<%= m.su %>.errors, status: :unprocessable_entity }
      end
    end
  end

  def destroy
    @<%= m.su %> = <%= m.sc %>.find(params[:id])
    @<%= m.su %>.destroy

    respond_to do |format|
      format.html { redirect_to <%= m.mu %> }
      format.json { head :ok }
    end
  end
end
--

<%- end -%>

--[template/view.csv:c]-------------------------------------
,,,etc,etc,etc,etc,etc,css,css,
,,,cattr_val,header,cell_val,klass,tooltip,text-align,width,
<%- OOHelper::Models.new(csv_fname).models do |m| -%>
<%- # index.html -%>
<%= m.single %>-index,cattrs,views,<%= m.multiple %>#index
<%= m.single %>-index,cattrs,location,main
<%= m.single %>-index,cattrs,template,index
<%= m.single %>-index,cattrs,locals,<%= m.multiple %>
<%= m.single %>-index,cattrs,before_each,<%= m.multiple %>
<%= m.single %>-index,cattrs,ja_name,<%= m.single %>_ja_name_TODO
<%= m.single %>-index,cattrs,in_global_menu,TRUE
<%= m.single %>-index,cattrs,header,xxxHEADER(<%= m.single %>_index)
<%- m.attrs do |a| -%>
<%= m.single %>-index,attrs,<%= a.name %>,,{default},"link_to <%= m.single %>.<%= a.name %>, <%= m.single %>_path(<%= m.single %>.id)"
<%- end -%>
<%- # new.html, edit.htmlç”¨ -%>
<%= m.single %>-edit,cattrs,views,"<%= m.multiple %>#new, <%= m.multiple %>#edit"
<%= m.single %>-edit,cattrs,location,main
<%= m.single %>-edit,cattrs,template,show
<%= m.single %>-edit,cattrs,locals,"<%= m.single %>,f"
<%= m.single %>-edit,cattrs,ja_name,<%= m.single %>_ja_name_TODO
<%= m.single %>-edit,cattrs,in_global_menu,<%= m.single %>
<%= m.single %>-edit,cattrs,header,xxxHEADER(<%= m.single %>_new)
<%= m.single %>-edit,cattrs,submit,normal
<%- m.attrs do |a| -%>
<%= m.single %>-edit,attrs,<%= a.name %>,,{default},"f.text_field :<%= a.name %>"
<%- end -%>
<%- # show.html -%>
<%= m.single %>-show,cattrs,views,<%= m.multiple %>#show
<%= m.single %>-show,cattrs,location,main
<%= m.single %>-show,cattrs,template,show
<%= m.single %>-show,cattrs,locals,<%= m.single %>
<%= m.single %>-show,cattrs,ja_name,<%= m.single %>_ja_name_TODO
<%= m.single %>-show,cattrs,in_global_menu,<%= m.single %>
<%= m.single %>-show,cattrs,header,xxxHEADER(<%= m.single %>_new
<%- m.attrs do |a| -%>
<%= m.single %>-show,attrs,<%= a.name %>,,{default},<%= m.single %>.<%= a.name %>
<%- end -%>
<%- end -%>
--

